<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Payslip Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        header {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2c53ff;
            padding: 20px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #ffffff;
        }

        .form-container {
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative; /* Added for better error message positioning */
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            transition: color 0.3s ease;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        .earnings-deductions {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .earnings, .deductions {
            flex: 1;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            color: #444;
        }

        .add-item {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }

        .remove-item {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 2px 6px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
        }

        .items-list {
            margin-top: 10px;
        }

        .item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            position: relative; /* Added for error message positioning */
            flex-wrap: wrap; /* Allow wrapping for error messages */
        }

        .item input {
            flex: 1;
            margin-right: 10px;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-generate {
            background-color: #4CAF50;
            color: white;
        }

        .btn-clear {
            background-color: #f44336;
            color: white;
        }

        .btn-save {
            background-color: #2196F3;
            color: white;
        }

        .btn-view-payslips {
            background-color: #ff9800;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .payslip-list {
            margin-top: 30px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .payslip-list h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            border-bottom: 2px solid #2c53ff;
            padding-bottom: 10px;
        }

        .payslip-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-start;
        }

        .payslip-filter label {
            font-weight: 500;
            color: #2c3e50;
            width: 25%;
        }

        .payslip-filter input[type="month"] {
            width: 200px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
        }

        .payslip-filter input[type="month"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .payslips-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .payslips-table thead {
            background-color: #2c53ff;
            color: #fff;
        }

        .payslips-table th {
            padding: 12px 15px;
            font-weight: 600;
            text-align: center;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payslips-table td {
            padding: 12px 15px;
            font-size: 14px;
            text-align: center;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .payslips-table tr:last-child td {
            border-bottom: none;
        }

        .payslips-table tr:hover {
            background-color: #f8fafc;
            transition: background-color 0.2s ease;
        }

        .payslips-table .action-btn {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .payslips-table .action-btn.view {
            background-color: #2196F3;
        }

        .payslips-table .action-btn.delete {
            background-color: #f44336;
        }

        .payslips-table .action-btn:hover {
            opacity: 0.85;
        }

        .action-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }

        .action-btn.delete {
            background-color: #f44336;
        }

        .notification {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: white;
            display: none;
        }

        .success {
            background-color: #4CAF50;
        }

        .error {
            background-color: #f44336;
        }

        .preview-containerbiological {
            display: none;
            margin-top: 30px;
        }

        .payslip {
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            background-color: white;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 200mm;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .payslip-header .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .company-logo {
            width: 180px;
            height: 100px;
            border-radius: 10px;
            object-fit: contain;
            background-color: #f9f9f9;
        }

        .company-details {
            text-align: right;
            max-width: 50%;
        }

        .company-details h2 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #2c3e50;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .company-details p {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.5;
        }

        .payslip-header h3 {
            text-align: center;
            margin-top: 10px;
            color: #34495e;
            font-size: 20px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payslip-details .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .payslip-details .details-table td {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #d0d0d0;
            color: #2c3e50;
        }

        .detail-label {
            font-weight: 500;
            color: #34495e;
        }

        .earnings-deductions {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .earnings, .deductions {
            flex: 1;
            background-color: #fff;
            border: 1px solid #d0d0d0;
            border-radius: 5px;
        }

        .payslip-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .payslip-table th, .payslip-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #d0d0d0;
            font-size: 14px;
        }

        .payslip-table th {
            background-color: #ecf0f1;
            font-weight: 600;
            color: #34495e;
        }

        .payslip-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .payslip-table tfoot td {
            font-weight: 500;
            background-color: #ecf0f1;
        }

        .payslip-total {
            text-align: left;
            font-weight: 500;
            margin-top: 20px;
            font-size: 16px;
            color: #2c3e50;
        }

        #preview-amount-in-words {
            margin-top: 10px;
            font-style: italic;
            font-size: 14px;
            color: #7f8c8d;
        }

        .payslip-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .form-row, .earnings-deductions {
                flex-direction: column;
            }
            .form-col, .earnings, .deductions {
                width: 100%;
            }
            .payslip-list {
                padding: 15px;
            }
            .payslip-filter {
                flex-direction: column;
                align-items: flex-start;
            }
            .payslip-filter input[type="month"] {
                width: 100%;
            }
            .payslips-table th, .payslips-table td {
                padding: 10px;
                font-size: 13px;
            }
            .payslips-table .action-btn {
                padding: 5px 10px;
                font-size: 12px;
            }
            .payslip-header .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            .company-details {
                text-align: left;
                margin-top: 15px;
                max-width: 100%;
            }
            .company-logo {
                width: 150px;
                height: 80px;
            }
        }

        .error-message {
            color: red;
            font-size: 12px;
            display: block; /* Ensure it takes its own line */
            margin-top: 4px; /* Space between input and error message */
            width: 100%; /* Ensure it aligns with the input width */
        }

        /* Adjust item layout to ensure error messages appear below inputs */
        .item .error-message {
            flex-basis: 100%; /* Make error message take full width of the item */
            margin-left: 0; /* Remove any side margin */
            margin-top: 4px; /* Space between input and error message */
        }
    </style>
</head>
<body>
    <header>
        <h1>HR PAYSLIP GENERATOR</h1>
    </header>
    <div class="container">
        <div class="notification success" id="success-notification"></div>
        <div class="notification error" id="error-notification"></div>

        <div class="form-container" id="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="employee-id">Employee ID:</label>
                    <input type="text" id="employee-id" placeholder="e.g., ATS0123" maxlength="7">
                    <span class="error-message" id="employee-id-error"></span>
                </div>
                <div class="form-group">
                    <label for="employee-name">Employee Name:</label>
                    <input type="text" id="employee-name" placeholder="e.g., John Doe" maxlength="30">
                    <span class="error-message" id="employee-name-error"></span>
                </div>
                <div class="form-group">
                    <label for="designation">Designation:</label>
                    <input type="text" id="designation" placeholder="e.g., Software Engineer" maxlength="30">
                    <span class="error-message" id="designation-error"></span>
                </div>
                <div class="form-group">
                    <label for="date-joining">Date of Joining:</label>
                    <input type="date" id="date-joining">
                    <span class="error-message" id="date-joining-error"></span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="month-year">Month & Year:</label>
                    <input type="month" id="month-year">
                    <span class="error-message" id="month-year-error"></span>
                </div>
                <div class="form-group">
                    <label for="employee-type">Employee Type:</label>
                    <select id="employee-type">
                        <option value="Permanent">Permanent</option>
                        <option value="Contract">Contract</option>
                        <option value="Intern">Intern</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="location">Current Office:</label>
                    <input type="text" id="location" placeholder="e.g., Hyderabad" maxlength="30">
                    <span class="error-message" id="location-error"></span>
                </div>
                <div class="form-group">
                    <label for="bank-name">Bank Name:</label>
                    <input type="text" id="bank-name" placeholder="e.g., HDFC Bank" maxlength="30">
                    <span class="error-message" id="bank-name-error"></span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="account-no">Bank Account No:</label>
                    <input type="text" id="account-no" placeholder="e.g., 123456789012" maxlength="16">
                    <span class="error-message" id="account-no-error"></span>
                </div>
                <div class="form-group">
                    <label for="working-days">Working Days:</label>
                    <input type="number" id="working-days" min="0" max="31" placeholder="e.g., 30">
                    <span class="error-message" id="working-days-error"></span>
                </div>
                <div class="form-group">
                    <label for="lop">Loss of Pay (Days):</label>
                    <input type="number" id="lop" min="0" max="31" placeholder="e.g., 2">
                    <span class="error-message" id="lop-error"></span>
                </div>
                <div class="form-group">
                    <label for="pan">PAN No:</label>
                    <input type="text" id="pan" placeholder="e.g., ABCDE1234F" maxlength="10">
                    <span class="error-message" id="pan-error"></span>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="provident-fund">Provident Fund:</label>
                    <input type="text" id="provident-fund" placeholder="e.g., PF123456" maxlength="20">
                    <span class="error-message" id="provident-fund-error"></span>
                </div>
                <div class="form-group">
                    <label for="uan">UAN No:</label>
                    <input type="text" id="uan" placeholder="e.g., 100123456789" maxlength="12">
                    <span class="error-message" id="uan-error"></span>
                </div>
                <div class="form-group">
                    <label for="esic">ESIC No:</label>
                    <input type="text" id="esic" placeholder="e.g., ESIC987654" maxlength="20">
                    <span class="error-message" id="esic-error"></span>
                </div>
            </div>

            <div class="earnings-deductions">
                <div class="earnings">
                    <h3>Earnings</h3>
                    <div class="items-list" id="earnings-list">
                        <div class="item">
                            <input type="text" placeholder="Component name" value="Basic" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                        <div class="item">
                            <input type="text" placeholder="Component name" value="House Rent Allowance" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                    </div>
                    <button type="button" class="add-item" id="add-earning">Add Earning</button>
                </div>
                <div class="deductions">
                    <h3>Deductions</h3>
                    <div class="items-list" id="deductions-list">
                        <div class="item">
                            <input type="text" placeholder="Component name" value="Professional Tax" class="component-name">
                            <input type="number" placeholder="Amount" min="0" class="component-amount">
                            <button type="button" class="remove-item">✕</button>
                        </div>
                    </div>
                    <button type="button" class="add-item" id="add-deduction">Add Deduction</button>
                </div>
            </div>

            <div class="buttons">
                <button type="button" class="btn btn-clear" id="clear-form">Clear Form</button>
                <button type="button" class="btn btn-generate" id="preview-payslip">Preview Payslip</button>
                <button type="button" class="btn btn-save" id="save-payslip">Generate & Save</button>
                <button type="button" class="btn btn-view-payslips" id="view-payslips">View Generated Payslips</button>
            </div>
        </div>

        <div class="payslip-list" id="payslip-list" style="display: none;">
            <h2>Generated Payslips</h2>
             <div class="buttons" style="float: right;">
                <button type="button" class="btn btn-clear" id="back-to-form">Back to Form</button>
            </div>
            <div class="payslip-filter">
                <label for="payslip-month-filter">Filter by Month & Year:</label>
                <input type="month" id="payslip-month-filter">
                <span class="error-message" id="payslip-month-filter-error"></span>
            </div>
            <table class="payslips-table" id="payslips-table">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Employee Name</th>
                        <th>Month & Year</th>
                        <th>Net Pay</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic content will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="preview-container" id="preview-container">
            <div class="payslip">
                <div class="payslip-header">
                    <div class="header-top">
                        <img src="logo/ATS_Wallpaper.jpg" alt="ATS Logo" class="company-logo" />
                        <div class="company-details">
                            <h2>Astrolite Tech Solutions Pvt Ltd</h2>
                            <p>Plot No 65, Flat No 201, 2nd Floor, Siddivinayaka Nagar, Survey of India, Madhapur, HYDERABAD -081</p>
                        </div>
                    </div>
                    <h3>Salary Slip for <span id="preview-month-year"></span></h3>
                </div>

                <div class="payslip-details">
                    <table class="details-table">
                        <tr>
                            <td><span class="detail-label">Employee Name:</span> <span id="preview-name"></span></td>
                            <td><span class="detail-label">Employee Type:</span> <span id="preview-type"></span><span class="detail-label" style="border-left:2px solid #9e9e9e;padding-left: 5px; margin-left: 5px;">Employee Code:</span> <span id="preview-id"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">Designation:</span> <span id="preview-designation"></span></td>
                            <td><span class="detail-label">Duration:</span> <span id="preview-duration"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">Date of Joining:</span> <span id="preview-doj"></span></td>
                            <td><span class="detail-label">Working Days:</span> <span id="preview-working-days"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">Current Office Location:</span> <span id="preview-location"></span></td>
                            <td><span class="detail-label">LOP:</span> <span id="preview-lop"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">Bank Name:</span> <span id="preview-bank"></span></td>
                            <td><span class="detail-label">PAN No:</span> <span id="preview-pan"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">Bank Account No:</span> <span id="preview-account"></span></td>
                            <td><span class="detail-label">Provident Fund:</span> <span id="preview-provident-fund"></span></td>
                        </tr>
                        <tr>
                            <td><span class="detail-label">UAN No:</span> <span id="preview-uan"></span></td>
                            <td><span class="detail-label">ESIC No:</span> <span id="preview-esic"></span></td>
                        </tr>
                    </table>
                </div>

                <div class="earnings-deductions">
                    <div class="earnings">
                        <table class="payslip-table">
                            <thead>
                                <tr>
                                    <th>Components</th>
                                    <th>Amount (Rs.)</th>
                                </tr>
                            </thead>
                            <tbody id="preview-earnings-table">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td><strong>Gross Pay (A)</strong></td>
                                    <td><strong id="preview-gross-pay">0</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="deductions">
                        <table class="payslip-table">
                            <thead>
                                <tr>
                                    <th>Common Deductions</th>
                                    <th>Amount (Rs.)</th>
                                </tr>
                            </thead>
                            <tbody id="preview-deductions-table">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td><strong>Total Deductions (B)</strong></td>
                                    <td><strong id="preview-total-deductions">0</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="payslip-total">
                    Net Pay (A - B): <span id="preview-net-pay">0</span>
                </div>

                <div id="preview-amount-in-words"></div>

                <div class="payslip-footer">
                    <p>Note: This is a Computer-Generated Slip and does not require signature</p>
                </div>

                <div class="preview-actions">
                    <button type="button" class="btn btn-clear" id="close-preview">Back to Form</button>
                    <button type="button" class="btn btn-save" id="download-payslip">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('payslip-list').style.display = 'none';
            
            const monthYearInput = document.getElementById('month-year');
            const payslipMonthFilter = document.getElementById('payslip-month-filter');
            const currentDate = new Date();
            const maxMonth = currentDate.toISOString().slice(0, 7);
            const minDate = new Date(currentDate.getFullYear() - 1, currentDate.getMonth(), 1);
            const minMonth = minDate.toISOString().slice(0, 7);
            monthYearInput.setAttribute('min', minMonth);
            monthYearInput.setAttribute('max', maxMonth);
            payslipMonthFilter.setAttribute('min', minMonth);
            payslipMonthFilter.setAttribute('max', maxMonth);

            let allPayslips = [];
            loadPayslips();

            function calculateLOPDeduction(grossPay, workingDays, lop) {
                if (isNaN(grossPay) || isNaN(workingDays) || isNaN(lop)) {
                    return 0;
                }
                if (workingDays === 0) {
                    return 0;
                }
                const dailyRate = grossPay / workingDays;
                const lopDeduction = dailyRate * lop;
                return Math.round(lopDeduction * 100) / 100;
            }

            function setupInputRestrictions() {
                const inputs = [
                    { id: 'employee-id', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 7, validate: validateEmployeeId, errorId: 'employee-id-error' },
                    { id: 'employee-name', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'employee-name-error' },
                    { id: 'designation', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'designation-error' },
                    { id: 'location', regex: /[^A-Za-z\s]/g, max: 30, validate: validateAlphabeticWithSpaces, errorId: 'location-error' },
                    { id: 'bank-name', regex: /[^A-Za-z\s]/g, transform: 'toUpperCase', max: 30, validate: validateAlphabeticWithSpaces, errorId: 'bank-name-error' },
                    { id: 'pan', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 10, validate: validatePAN, errorId: 'pan-error' },
                    { id: 'account-no', regex: /\D/g, max: 16, validate: validateBankAccount, errorId: 'account-no-error' },
                    { id: 'working-days', regex: /\D/g, max: 31, validate: validateWorkingDays, errorId: 'working-days-error' },
                    { id: 'lop', regex: /\D/g, max: 31, validate: validateLOP, errorId: 'lop-error' },
                    { id: 'provident-fund', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 20, validate: validateProvidentFund, errorId: 'provident-fund-error' },
                    { id: 'uan', regex: /\D/g, max: 12, validate: validateUAN, errorId: 'uan-error' },
                    { id: 'esic', regex: /[^A-Z0-9]/g, transform: 'toUpperCase', max: 20, validate: validateESIC, errorId: 'esic-error' }
                ];

                inputs.forEach(input => {
                    const element = document.getElementById(input.id);
                    element.addEventListener('input', function(e) {
                        let value = e.target.value.replace(input.regex, '');
                        if (input.transform) value = value[input.transform]();
                        
                        if (['employee-name', 'designation', 'location', 'bank-name'].includes(input.id)) {
                            value = value.replace(/^\s+/, '');
                            value = value.replace(/\s+/g, ' ');
                            if (!/[A-Za-z]/.test(value)) value = value.replace(/\s/g, '');
                        }

                        if (input.max) value = value.slice(0, input.max);
                        if (input.id === 'working-days' || input.id === 'lop') {
                            value = Math.min(Math.max(0, parseInt(value) || 0), 31);
                        }
                        e.target.value = value;

                        const errorElement = document.getElementById(input.errorId);
                        if (input.validate) {
                            if (!input.validate(value)) {
                                errorElement.textContent = getErrorMessage(input.id);
                            } else {
                                errorElement.textContent = '';
                            }
                        }
                    });
                });

                document.getElementById('date-joining').addEventListener('input', function(e) {
                    const errorElement = document.getElementById('date-joining-error');
                    const today = new Date();
                    const minDate = new Date('1990-01-01');
                    const joiningDate = new Date(e.target.value);
                    if (!e.target.value || joiningDate > today || joiningDate < minDate) {
                        errorElement.textContent = 'Joining date must be between Jan 1, 1990 and today';
                    } else {
                        errorElement.textContent = '';
                    }
                });

                document.getElementById('month-year').addEventListener('input', function(e) {
                    const errorElement = document.getElementById('month-year-error');
                    const selectedDate = new Date(e.target.value);
                    const minAllowedDate = new Date(minMonth);
                    const maxAllowedDate = new Date(maxMonth);
                    
                    if (!e.target.value) {
                        errorElement.textContent = 'Month and Year are required';
                    } else if (selectedDate < minAllowedDate || selectedDate > maxAllowedDate) {
                        errorElement.textContent = 'Select a month within the past 12 months or current month';
                        e.target.value = '';
                    } else {
                        errorElement.textContent = '';
                    }
                });

                document.getElementById('payslip-month-filter').addEventListener('input', function(e) {
                    const errorElement = document.getElementById('payslip-month-filter-error');
                    const selectedDate = new Date(e.target.value);
                    const minAllowedDate = new Date(minMonth);
                    const maxAllowedDate = new Date(maxMonth);
                    
                    if (!e.target.value) {
                        errorElement.textContent = '';
                        filterPayslips('');
                    } else if (selectedDate < minAllowedDate || selectedDate > maxAllowedDate) {
                        errorElement.textContent = 'Select a month within the past 12 months or current month';
                        e.target.value = '';
                        filterPayslips('');
                    } else {
                        errorElement.textContent = '';
                        filterPayslips(e.target.value);
                    }
                });

                const setupComponentRestrictions = (list) => {
    list.addEventListener('input', function(e) {
        if (e.target.classList.contains('component-name')) {
            let value = e.target.value.replace(/[^A-Za-z\s]/g, '');
            value = value.replace(/^\s+/, '');
            value = value.replace(/\s+/g, ' ');
            if (!/[A-Za-z]/.test(value)) value = value.replace(/\s/g, '');
            e.target.value = value.slice(0, 30);
            const isValid = validateComponentName(e.target.value);
            e.target.style.borderColor = isValid ? '#bdc3c7' : 'red';

            let errorElement = e.target.parentElement.querySelector('.error-message');
            if (!isValid) {
                if (!errorElement) {
                    errorElement = document.createElement('span');
                    errorElement.className = 'error-message';
                    e.target.parentElement.appendChild(errorElement);
                }
                errorElement.textContent = 'Component name must contain at least 5 letters';
            } else {
                if (errorElement) {
                    errorElement.remove();
                }
            }
            validateEarningsAndDeductions(); // Add this line to revalidate
        }
        if (e.target.classList.contains('component-amount')) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.slice(0, 7);
            e.target.value = value;
            const amount = parseFloat(value);
            const isValid = value !== '' && !isNaN(amount) && amount >= 0 && value.length <= 7;
            e.target.style.borderColor = isValid ? '#bdc3c7' : 'red';

            let errorElement = e.target.parentElement.querySelector('.error-message');
            if (!isValid) {
                if (!errorElement) {
                    errorElement = document.createElement('span');
                    errorElement.className = 'error-message';
                    e.target.parentElement.appendChild(errorElement);
                }
                errorElement.textContent = 'Amount must be a positive number (max 7 digits)';
            } else {
                if (errorElement) {
                    errorElement.remove();
                }
            }
            validateEarningsAndDeductions(); // Add this line to revalidate
        }
    });
};

                setupComponentRestrictions(document.getElementById('earnings-list'));
                setupComponentRestrictions(document.getElementById('deductions-list'));
            }

            setupInputRestrictions();

            document.getElementById('add-earning').addEventListener('click', function() { addItem('earnings-list'); });
            document.getElementById('add-deduction').addEventListener('click', function() { addItem('deductions-list'); });
            document.getElementById('preview-payslip').addEventListener('click', previewPayslip);
            document.getElementById('save-payslip').addEventListener('click', savePayslip);
            document.getElementById('clear-form').addEventListener('click', clearForm);
            document.getElementById('close-preview').addEventListener('click', closePreview);
            document.getElementById('download-payslip').addEventListener('click', downloadPayslip);
            document.getElementById('view-payslips').addEventListener('click', showPayslipList);
            document.getElementById('back-to-form').addEventListener('click', showForm);

            function validateEmployeeId(id) {
                const employeeIdRegex = /^ATS0(?!000)\d{3}$/;
                return employeeIdRegex.test(id.trim());
            }

            function validateAlphabeticWithSpaces(input) {
                const alphabetRegex = /^[A-Za-z]+(?:\s[A-Za-z]+)*$/;
                const alphaCount = (input.match(/[A-Za-z]/g) || []).length;
                const trimmedInput = input.trim();
                return trimmedInput.length >= 5 && 
                       trimmedInput.length <= 30 && 
                       alphabetRegex.test(trimmedInput) && 
                       alphaCount >= 5 &&
                       /[A-Za-z]/.test(trimmedInput);
            }

            function validatePAN(pan) {
                const panRegex = /^[A-Z]{5}\d{4}[A-Z]$/;
                return panRegex.test(pan.trim());
            }

            function validateBankAccount(account) {
                const accountRegex = /^\d{9,16}$/;
                return accountRegex.test(account.trim());
            }

            function validateWorkingDays(days) {
                const daysNum = parseInt(days);
                return !isNaN(daysNum) && daysNum >= 0 && daysNum <= 31;
            }

            function validateLOP(lop) {
                const lopNum = parseInt(lop);
                return !isNaN(lopNum) && lopNum >= 0 && lopNum <= 31;
            }

            function validateProvidentFund(pf) {
                const pfRegex = /^[A-Z0-9]{5,20}$/;
                return pf === '' || pfRegex.test(pf.trim());
            }

            function validateUAN(uan) {
                const uanRegex = /^\d{12}$/;
                return uan === '' || uanRegex.test(uan.trim());
            }

            function validateESIC(esic) {
                const esicRegex = /^[A-Z0-9]{5,20}$/;
                return esic === '' || esicRegex.test(esic.trim());
            }

            function validateComponentName(name) {
                return validateAlphabeticWithSpaces(name);
            }

            function getErrorMessage(fieldId) {
                const messages = {
                    'employee-id': 'Must start with ATS0 followed by 3 digits (not 000)',
                    'employee-name': 'Must contain at least 5 alphabetic characters (max 30)',
                    'designation': 'Must contain at least 5 alphabetic characters (max 30)',
                    'location': 'Must contain at least 5 alphabetic characters (max 30)',
                    'bank-name': 'Must contain at least 5 alphabetic characters (max 30)',
                    'pan': 'Invalid PAN format (e.g., ABCDE1234F)',
                    'account-no': 'Must be 9-16 digits',
                    'working-days': 'Must be between 0-31',
                    'lop': 'Must be between 0-31',
                    'provident-fund': 'Must be 5-20 alphanumeric characters (optional)',
                    'uan': 'Must be exactly 12 digits (optional)',
                    'esic': 'Must be 5-20 alphanumeric characters (optional)'
                };
                return messages[fieldId] || 'Invalid input';
            }

            function validateEarningsAndDeductions() {
    let isValid = true;
    const earningsList = document.getElementById('earnings-list');
    const deductionsList = document.getElementById('deductions-list');
    let errorMessage = '';

    const earningsItems = earningsList.querySelectorAll('.item');
    if (earningsItems.length === 0) {
        errorMessage += 'At least one earning is required. ';
        isValid = false;
    }

    earningsItems.forEach(item => {
        const nameInput = item.querySelector('.component-name');
        const amountInput = item.querySelector('.component-amount');
        
        if (!validateComponentName(nameInput.value)) {
            isValid = false;
            errorMessage += 'Earnings: Invalid component name (min 5 letters). ';
        }
        
        const amount = parseFloat(amountInput.value);
        if (!amountInput.value || isNaN(amount) || amount < 0) {
            isValid = false;
            errorMessage += 'Earnings: Amount must be a positive number. ';
        }
    });

    deductionsList.querySelectorAll('.item').forEach(item => {
        const nameInput = item.querySelector('.component-name');
        const amountInput = item.querySelector('.component-amount');
        
        if (!validateComponentName(nameInput.value)) {
            isValid = false;
            errorMessage += 'Deductions: Invalid component name (min 5 letters). ';
        }
        
        const amount = parseFloat(amountInput.value);
        if (!amountInput.value || isNaN(amount) || amount < 0) {
            isValid = false;
            errorMessage += 'Deductions: Amount must be a positive number. ';
        }
    });

    const errorNotification = document.getElementById('error-notification');
    if (!isValid) {
        errorNotification.textContent = errorMessage;
        errorNotification.style.display = 'block';

        // Clear any existing timeout to reset the timer
        if (errorNotification.timeoutId) {
            clearTimeout(errorNotification.timeoutId);
        }

        // Set a timeout to hide the notification after 3 seconds
        errorNotification.timeoutId = setTimeout(() => {
            errorNotification.style.display = 'none';
            errorNotification.textContent = '';
        }, 3000);
    } else {
        // Hide the notification immediately if the form is valid
        errorNotification.style.display = 'none';
        errorNotification.textContent = '';
    }

    return isValid;
}

            function validateForm() {
                let isValid = true;
                const fields = [
                    { id: 'employee-id', validate: validateEmployeeId },
                    { id: 'employee-name', validate: validateAlphabeticWithSpaces },
                    { id: 'designation', validate: validateAlphabeticWithSpaces },
                    { id: 'location', validate: validateAlphabeticWithSpaces },
                    { id: 'bank-name', validate: validateAlphabeticWithSpaces },
                    { id: 'pan', validate: validatePAN },
                    { id: 'account-no', validate: validateBankAccount },
                    { id: 'working-days', validate: validateWorkingDays },
                    { id: 'lop', validate: validateLOP },
                    { id: 'provident-fund', validate: validateProvidentFund },
                    { id: 'uan', validate: validateUAN },
                    { id: 'esic', validate: validateESIC }
                ];

                document.getElementById('error-notification').style.display = 'none';

                fields.forEach(field => {
                    const value = document.getElementById(field.id).value;
                    const errorElement = document.getElementById(`${field.id}-error`);
                    if (!field.validate(value)) {
                        errorElement.textContent = getErrorMessage(field.id);
                        isValid = false;
                    } else {
                        errorElement.textContent = '';
                    }
                });

                const dateJoining = document.getElementById('date-joining').value;
                const dateJoiningError = document.getElementById('date-joining-error');
                const today = new Date();
                const minDate = new Date('1990-01-01');
                const joiningDate = new Date(dateJoining);
                if (!dateJoining || joiningDate > today || joiningDate < minDate) {
                    dateJoiningError.textContent = 'Joining date must be between Jan 1, 1990 and today';
                    isValid = false;
                } else {
                    dateJoiningError.textContent = '';
                }

                const monthYear = document.getElementById('month-year').value;
                const monthYearError = document.getElementById('month-year-error');
                const selectedDate = new Date(monthYear);
                const minAllowedDate = new Date(minMonth);
                const maxAllowedDate = new Date(maxMonth);

                if (!monthYear) {
                    monthYearError.textContent = 'Month and Year are required';
                    isValid = false;
                } else if (selectedDate < minAllowedDate || selectedDate > maxAllowedDate) {
                    monthYearError.textContent = 'Select a month within the past 12 months or current month';
                    isValid = false;
                } else {
                    monthYearError.textContent = '';
                }

                if (!validateEarningsAndDeductions()) {
                    isValid = false;
                }

                if (!isValid && !document.getElementById('error-notification').textContent) {
                    document.getElementById('error-notification').textContent = 'Please correct the highlighted errors';
                    document.getElementById('error-notification').style.display = 'block';
                }

                return isValid;
            }

            function addItem(listId) {
                const list = document.getElementById(listId);
                const newItem = document.createElement('div');
                newItem.className = 'item';
                newItem.innerHTML = `
                    <input type="text" placeholder="Component name" class="component-name">
                    <input type="number" placeholder="Amount" min="0" class="component-amount">
                    <button type="button" class="remove-item">✕</button>
                `;
                list.appendChild(newItem);
            }

            function previewPayslip() {
                if (validateForm()) {
                    const formData = collectFormData();
                    populatePreview(formData);
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('preview-container').style.display = 'block';
                    document.getElementById('payslip-list').style.display = 'none';
                }
            }

            function closePreview() {
                document.getElementById('preview-container').style.display = 'none';
                document.getElementById('form-container').style.display = 'block';
                document.getElementById('payslip-list').style.display = 'none';
            }

            function showPayslipList() {
                document.getElementById('form-container').style.display = 'none';
                document.getElementById('payslip-list').style.display = 'block';
                document.getElementById('preview-container').style.display = 'none';
                document.getElementById('payslip-month-filter').value = '';
                filterPayslips('');
            }

            function showForm() {
                document.getElementById('form-container').style.display = 'block';
                document.getElementById('payslip-list').style.display = 'none';
                document.getElementById('preview-container').style.display = 'none';
            }

            async function savePayslip() {
                if (validateForm()) {
                    const formData = collectFormData();
                    console.log('Sending formData:', JSON.stringify(formData, null, 2));
                    try {
                        const response = await fetch('http://16.171.200.23:3089/api/payslips', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('API error response:', errorData);
                            throw new Error(errorData.error || 'Failed to save payslip');
                        }
                        const result = await response.json();
                        populatePreview(formData);
                        document.getElementById('form-container').style.display = 'none';
                        document.getElementById('preview-container').style.display = 'block';
                        document.getElementById('payslip-list').style.display = 'none';
                        loadPayslips();
                        showNotification('success', 'Payslip generated and saved successfully!');
                        clearForm();
                    } catch (error) {
                        console.error('Error saving payslip:', error);
                        showNotification('error', error.message || 'Failed to save payslip');
                    }
                }
            }

            function collectFormData() {
                const monthYear = document.getElementById('month-year').value;
                const date = new Date(monthYear);
                const monthNames = ["January", "February", "March", "April", "May", "June", 
                                  "July", "August", "September", "October", "November", "December"];
                const monthYearFormatted = monthNames[date.getMonth()] + ' ' + date.getFullYear();

                const formData = {
                    employeeId: document.getElementById('employee-id').value,
                    employeeName: document.getElementById('employee-name').value,
                    designation: document.getElementById('designation').value,
                    dateJoining: document.getElementById('date-joining').value,
                    monthYear: monthYear,
                    monthYearFormatted: monthYearFormatted,
                    employeeType: document.getElementById('employee-type').value,
                    location: document.getElementById('location').value,
                    bankName: document.getElementById('bank-name').value,
                    accountNo: document.getElementById('account-no').value,
                    workingDays: document.getElementById('working-days').value,
                    lop: document.getElementById('lop').value || '0',
                    pan: document.getElementById('pan').value,
                    providentFund: document.getElementById('provident-fund').value || null,
                    uan: document.getElementById('uan').value || null,
                    esic: document.getElementById('esic').value || null,
                    duration: formatDuration(monthYear),
                    earnings: [],
                    deductions: [],
                    grossPay: 0,
                    totalDeductions: 0,
                    netPay: 0
                };

                document.getElementById('earnings-list').querySelectorAll('.item').forEach(item => {
                    const [nameInput, amountInput] = item.querySelectorAll('input');
                    const component = nameInput.value;
                    const amount = parseFloat(amountInput.value) || 0;
                    if (component && !isNaN(amount)) {
                        formData.earnings.push({ component, amount });
                        formData.grossPay += amount;
                    }
                });

                document.getElementById('deductions-list').querySelectorAll('.item').forEach(item => {
                    const [nameInput, amountInput] = item.querySelectorAll('input');
                    const component = nameInput.value;
                    const amount = parseFloat(amountInput.value) || 0;
                    if (component && !isNaN(amount)) {
                        formData.deductions.push({ component, amount });
                        formData.totalDeductions += amount;
                    }
                });

                const workingDays = parseFloat(document.getElementById('working-days').value) || 0;
                const lop = parseFloat(document.getElementById('lop').value) || 0;
                const lopDeduction = calculateLOPDeduction(formData.grossPay, workingDays, lop);

                if (lop > 0 && lopDeduction > 0) {
                    formData.deductions.push({
                        component: 'Loss of Pay',
                        amount: lopDeduction
                    });
                    formData.totalDeductions += lopDeduction;
                }

                formData.netPay = formData.grossPay - formData.totalDeductions;

                return formData;
            }

            function formatDuration(monthYear) {
                if (!monthYear) return '';
                const date = new Date(monthYear);
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                return `1st ${firstDay.toLocaleDateString('en-US', { month: 'long' })} to ${lastDay.getDate()}${getDaySuffix(lastDay.getDate())} ${lastDay.toLocaleDateString('en-US', { month: 'long' })}, ${year}`;
            }

            function getDaySuffix(day) {
                if (day > 3 && day < 21) return 'th';
                switch (day % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            }

            function downloadPayslip() {
                const downloadButton = document.getElementById('download-payslip');
                downloadButton.disabled = true;
                downloadButton.textContent = 'Generating PDF...';

                try {
                    if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
                        showNotification('error', 'Required libraries (jsPDF or html2canvas) not loaded. Please try again later.');
                        downloadButton.disabled = false;
                        downloadButton.textContent = 'Download PDF';
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const payslipElement = document.querySelector('.preview-container');
                    const monthYear = document.getElementById('preview-month-year').textContent || 'Unknown';

                    if (!payslipElement) {
                        showNotification('error', 'Payslip content not found. Please try again.');
                        downloadButton.disabled = false;
                        downloadButton.textContent = 'Download PDF';
                        return;
                    }

                    const logoImg = payslipElement.querySelector('.company-logo');
                    const preloadImg = new Image();
                    preloadImg.crossOrigin = 'Anonymous';
                    preloadImg.src = logoImg.src;

                    preloadImg.onload = () => {
                        html2canvas(payslipElement, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#ffffff'
                        }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png', 1.0);
                            const doc = new jsPDF({
                                orientation: 'portrait',
                                unit: 'mm',
                                format: 'a4',
                                compress: true
                            });

                            const pdfWidth = doc.internal.pageSize.getWidth();
                            const pdfHeight = doc.internal.pageSize.getHeight();
                            const imgProps = doc.getImageProperties(imgData);
                            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

                            let heightLeft = imgHeight;
                            let position = 0;

                            while (heightLeft > 0) {
                                doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                heightLeft -= pdfHeight;
                                position -= pdfHeight;
                                if (heightLeft > 0) {
                                    doc.addPage();
                                }
                            }

                            doc.save(`Payslip_${monthYear.replace(/\s+/g, '_')}.pdf`);
                            downloadButton.disabled = false;
                            downloadButton.textContent = 'Download PDF';
                        }).catch(error => {
                            console.error('Error generating PDF with html2canvas:', error);
                            showNotification('error', 'Failed to generate PDF due to image loading issues. Please ensure the logo image is accessible.');
                            downloadButton.disabled = false;
                            downloadButton.textContent = 'Download PDF';
                        });
                    };

                    preloadImg.onerror = () => {
                        console.warn('Primary logo image failed to load. Attempting with fallback image.');
                        logoImg.src = 'https://placehold.co/180x100?text=Logo';
                        const fallbackImg = new Image();
                        fallbackImg.crossOrigin = 'Anonymous';
                        fallbackImg.src = logoImg.src;

                        fallbackImg.onload = () => {
                            html2canvas(payslipElement, {
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff'
                            }).then(canvas => {
                                const imgData = canvas.toDataURL('image/png', 1.0);
                                const doc = new jsPDF({
                                    orientation: 'portrait',
                                    unit: 'mm',
                                    format: 'a4',
                                    compress: true
                                });

                                const pdfWidth = doc.internal.pageSize.getWidth();
                                const pdfHeight = doc.internal.pageSize.getHeight();
                                const imgProps = doc.getImageProperties(imgData);
                                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

                                let heightLeft = imgHeight;
                                let position = 0;

                                while (heightLeft > 0) {
                                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                    heightLeft -= pdfHeight;
                                    position -= pdfHeight;
                                    if (heightLeft > 0) {
                                        doc.addPage();
                                    }
                                }

                                doc.save(`Payslip_${monthYear.replace(/\s+/g, '_')}.pdf`);
                                downloadButton.disabled = false;
                                downloadButton.textContent = 'Download PDF';
                            }).catch(error => {
                                console.error('Error generating PDF with fallback image:', error);
                                showNotification('error', 'Failed to generate PDF with fallback image. Proceeding without logo.');
                                logoImg.style.display = 'none';
                                html2canvas(payslipElement, {
                                    scale: 2,
                                    useCORS: true,
                                    logging: false,
                                    backgroundColor: '#ffffff'
                                }).then(canvas => {
                                    const imgData = canvas.toDataURL('image/png', 1.0);
                                    const doc = new jsPDF({
                                        orientation: 'portrait',
                                        unit: 'mm',
                                        format: 'a4',
                                        compress: true
                                    });

                                    const pdfWidth = doc.internal.pageSize.getWidth();
                                    const pdfHeight = doc.internal.pageSize.getHeight();
                                    const imgProps = doc.getImageProperties(imgData);
                                    const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

                                    let heightLeft = imgHeight;
                                    let position = 0;

                                    while (heightLeft > 0) {
                                        doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                        heightLeft -= pdfHeight;
                                        position -= pdfHeight;
                                        if (heightLeft > 0) {
                                            doc.addPage();
                                        }
                                    }

                                    doc.save(`Payslip_${monthYear.replace(/\s+/g, '_')}.pdf`);
                                    logoImg.style.display = '';
                                    downloadButton.disabled = false;
                                    downloadButton.textContent = 'Download PDF';
                                }).catch(error => {
                                    console.error('Error generating PDF without logo:', error);
                                    showNotification('error', 'Failed to generate PDF. Please check your network and try again.');
                                    logoImg.style.display = '';
                                    downloadButton.disabled = false;
                                    downloadButton.textContent = 'Download PDF';
                                });
                            });
                        };

                        fallbackImg.onerror = () => {
                            console.warn('Fallback image failed to load. Generating PDF without logo.');
                            showNotification('error', 'Image loading failed. Generating PDF without logo.');
                            logoImg.style.display = 'none';
                            html2canvas(payslipElement, {
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff'
                            }).then(canvas => {
                                const imgData = canvas.toDataURL('image/png', 1.0);
                                const doc = new jsPDF({
                                    orientation: 'portrait',
                                    unit: 'mm',
                                    format: 'a4',
                                    compress: true
                                });

                                const pdfWidth = doc.internal.pageSize.getWidth();
                                const pdfHeight = doc.internal.pageSize.getHeight();
                                const imgProps = doc.getImageProperties(imgData);
                                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;

                                let heightLeft = imgHeight;
                                let position = 0;

                                while (heightLeft > 0) {
                                    doc.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                                    heightLeft -= pdfHeight;
                                    position -= pdfHeight;
                                    if (heightLeft > 0) {
                                        doc.addPage();
                                    }
                                }

                                doc.save(`Payslip_${monthYear.replace(/\s+/g, '_')}.pdf`);
                                logoImg.style.display = '';
                                downloadButton.disabled = false;
                                downloadButton.textContent = 'Download PDF';
                            }).catch(error => {
                                console.error('Error generating PDF without logo:', error);
                                showNotification('error', 'Failed to generate PDF. Please check your network and try again.');
                                logoImg.style.display = '';
                                downloadButton.disabled = false;
                                downloadButton.textContent = 'Download PDF';
                            });
                        };
                    };
                } catch (error) {
                    console.error('Error in downloadPayslip:', error);
                    showNotification('error', 'Failed to generate PDF. Please try again.');
                    downloadButton.disabled = false;
                    downloadButton.textContent = 'Download PDF';
                }
            }

            async function loadPayslips() {
                try {
                    const response = await fetch('http://16.171.200.23:3089/api/payslips/all');
                    if (!response.ok) {
                        throw new Error('Failed to fetch payslips');
                    }
                    allPayslips = await response.json();
                    filterPayslips(document.getElementById('payslip-month-filter').value);
                } catch (error) {
                    console.error('Error loading payslips:', error);
                    showNotification('error', 'Failed to load payslips');
                }
            }

            function filterPayslips(monthYear) {
                const table = document.getElementById('payslips-table');
                table.querySelector('tbody').innerHTML = '';
                const filteredPayslips = monthYear 
                    ? allPayslips.filter(payslip => payslip.monthYear === monthYear)
                    : allPayslips;

                if (filteredPayslips.length === 0) {
                    table.querySelector('tbody').innerHTML = '<tr><td colspan="5">No payslips found for the selected month.</td></tr>';
                    return;
                }

                filteredPayslips.forEach(payslip => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', payslip.id);
                    row.setAttribute('data-employee-id', payslip.employeeId);
                    row.setAttribute('data-month-year', payslip.monthYear);
                    row.innerHTML = `
                        <td>${payslip.employeeId}</td>
                        <td>${payslip.employeeName}</td>
                        <td>${payslip.monthYearFormatted}</td>
                        <td>₹${payslip.netPay.toFixed(2)}</td>
                        <td>
                            <button class="action-btn view">View</button>
                            <button class="action-btn delete">Delete</button>
                        </td>
                    `;
                    table.querySelector('tbody').appendChild(row);
                });
            }

            async function deletePayslip(id) {
                try {
                    const response = await fetch(`http://16.171.200.23:3089/api/payslips/${id}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        throw new Error('Failed to delete payslip');
                    }
                    loadPayslips();
                    showNotification('success', 'Payslip deleted successfully!');
                } catch (error) {
                    console.error('Error deleting payslip:', error);
                    showNotification('error', 'Failed to delete payslip');
                }
            }

            async function viewPayslip(id) {
                console.log('Viewing payslip with ID:', id);
                try {
                    const response = await fetch(`http://16.171.200.23:3089/api/payslips/${id}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API error response:', errorData);
                        throw new Error(errorData.error || 'Failed to fetch payslip');
                    }
                    const payslip = await response.json();
                    populatePreview({
                        id: payslip.id,
                        employeeId: payslip.employee_id,
                        employeeName: payslip.employee_name,
                        designation: payslip.designation,
                        dateJoining: payslip.date_joining,
                        monthYear: payslip.month_year,
                        monthYearFormatted: formatMonthYear(payslip.month_year),
                        employeeType: payslip.employee_type,
                        location: payslip.location,
                        bankName: payslip.bank_name,
                        accountNo: payslip.account_no,
                        workingDays: payslip.working_days,
                        daysInMonth: getDaysInMonth(payslip.month_year),
                        lop: payslip.lop,
                        pan: payslip.pan,
                        providentFund: payslip.provident_fund,
                        uan: payslip.uan,
                        esic: payslip.esic,
                        duration: payslip.duration,
                        earnings: payslip.earnings,
                        deductions: payslip.deductions,
                        grossPay: payslip.gross_pay,
                        totalDeductions: payslip.total_deductions,
                        netPay: payslip.net_pay
                    });
                    document.getElementById('form-container').style.display = 'none';
                    document.getElementById('payslip-list').style.display = 'none';
                    document.getElementById('preview-container').style.display = 'block';
                } catch (error) {
                    console.error('Error viewing payslip:', error);
                    showNotification('error', error.message || 'Failed to view payslip');
                }
            }

            function clearForm() {
                document.getElementById('employee-id').value = '';
                document.getElementById('employee-name').value = '';
                document.getElementById('designation').value = '';
                document.getElementById('date-joining').value = '';
                document.getElementById('month-year').value = '';
                document.getElementById('employee-type').value = 'Permanent';
                document.getElementById('location').value = '';
                document.getElementById('bank-name').value = '';
                document.getElementById('account-no').value = '';
                document.getElementById('working-days').value = '';
                document.getElementById('lop').value = '';
                document.getElementById('pan').value = '';
                document.getElementById('provident-fund').value = '';
                document.getElementById('uan').value = '';
                document.getElementById('esic').value = '';
                
                document.getElementById('earnings-list').innerHTML = `
                    <div class="item">
                        <input type="text" placeholder="Component name" value="Basic" class="component-name">
                        <input type="number" placeholder="Amount" min="0" class="component-amount">
                        <button type="button" class="remove-item">✕</button>
                    </div>
                    <div class="item">
                        <input type="text" placeholder="Component name" value="House Rent Allowance" class="component-name">
                        <input type="number" placeholder="Amount" min="0" class="component-amount">
                        <button type="button" class="remove-item">✕</button>
                    </div>
                `;
                
                document.getElementById('deductions-list').innerHTML = `
                    <div class="item">
                        <input type="text" placeholder="Component name" value="Professional Tax" class="component-name">
                        <input type="number" placeholder="Amount" min="0" class="component-amount">
                        <button type="button" class="remove-item">✕</button>
                    </div>
                `;

                document.querySelectorAll('.error-message').forEach(msg => msg.textContent = '');
                document.getElementById('error-notification').style.display = 'none';
            }

            function showNotification(type, message) {
    const notification = document.getElementById(`${type}-notification`);
    notification.textContent = message;
    notification.style.display = 'block';

    // Clear any existing timeout to avoid overlapping timers
    if (notification.timeoutId) {
        clearTimeout(notification.timeoutId);
    }

    // Set a timeout to hide the notification after 3 seconds
    notification.timeoutId = setTimeout(() => {
        notification.style.display = 'none';
        notification.textContent = ''; // Clear the message
    }, 3000);
}

            document.getElementById('earnings-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    e.target.parentElement.remove();
                }
            });

            document.getElementById('deductions-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-item')) {
                    e.target.parentElement.remove();
                }
            });

            document.getElementById('payslips-table').addEventListener('click', function(e) {
                if (e.target.classList.contains('action-btn')) {
                    const row = e.target.closest('tr');
                    const id = row.getAttribute('data-id');
                    if (e.target.classList.contains('delete')) {
                        deletePayslip(id);
                    } else if (e.target.classList.contains('view')) {
                        viewPayslip(id);
                    }
                }
            });

            function populatePreview(formData) {
                document.getElementById('preview-month-year').textContent = formData.monthYearFormatted;
                document.getElementById('preview-name').textContent = formData.employeeName || '';
                document.getElementById('preview-designation').textContent = formData.designation || '';
                document.getElementById('preview-doj').textContent = formData.dateJoining || '';
                document.getElementById('preview-bank').textContent = formData.bankName || '';
                document.getElementById('preview-type').textContent = formData.employeeType || '';
                document.getElementById('preview-duration').textContent = formData.duration || '';
                document.getElementById('preview-working-days').textContent = formData.workingDays || '';
                document.getElementById('preview-account').textContent = formData.accountNo || '';
                document.getElementById('preview-id').textContent = formData.employeeId || '';
                document.getElementById('preview-location').textContent = formData.location || '';
                document.getElementById('preview-lop').textContent = formData.lop || '0';
                document.getElementById('preview-pan').textContent = formData.pan || '';
                document.getElementById('preview-provident-fund').textContent = formData.providentFund || '';
                document.getElementById('preview-uan').textContent = formData.uan || '';
                document.getElementById('preview-esic').textContent = formData.esic || '';

                const earningsTable = document.getElementById('preview-earnings-table');
                earningsTable.innerHTML = '';
                formData.earnings.forEach(earning => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${earning.component}</td><td>${earning.amount.toFixed(2)}</td>`;
                    earningsTable.appendChild(row);
                });

                const deductionsTable = document.getElementById('preview-deductions-table');
                deductionsTable.innerHTML = '';
                formData.deductions.forEach(deduction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${deduction.component}</td><td>${deduction.amount.toFixed(2)}</td>`;
                    deductionsTable.appendChild(row);
                });

                document.getElementById('preview-gross-pay').textContent = formData.grossPay.toFixed(2);
                document.getElementById('preview-total-deductions').textContent = formData.totalDeductions.toFixed(2);
                document.getElementById('preview-net-pay').textContent = formData.netPay.toFixed(2);
                document.getElementById('preview-amount-in-words').textContent = numberToWords(formData.netPay || 0) + ' Rupees only';
            }

            function numberToWords(number) {
                try {
                    const first = ['', 'One ', 'Two ', 'Three ', 'Four ', 'Five ', 'Six ', 'Seven ', 'Eight ', 'Nine ', 'Ten ', 
                                'Eleven ', 'Twelve ', 'Thirteen ', 'Fourteen ', 'Fifteen ', 'Sixteen ', 'Seventeen ', 
                                'Eighteen ', 'Nineteen '];
                    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                    const scales = ['', 'Thousand ', 'Lakh ', 'Crore '];
                    
                    if (!number || number < 0) return 'Zero';
                    
                    const numStr = Number(number).toFixed(2);
                    const parts = numStr.split('.');
                    const wholePart = parseInt(parts[0]);
                    const decimalPart = parseInt(parts[1]);
                    
                    function convertWholeNumber(num) {
                        if (num === 0) return '';
                        
                        let words = '';
                        
                        const hundreds = num % 1000;
                        if (hundreds > 0) {
                            if (hundreds < 20) {
                                words = first[hundreds] + ' ';
                            } else {
                                const tensValue = Math.floor(hundreds / 10) % 10;
                                const onesValue = hundreds % 10;
                                words = tens[tensValue] + (onesValue > 0 ? ' ' + first[onesValue] : '') + ' ';
                            }
                        }
                        
                        num = Math.floor(num / 1000);
                        if (num > 0) {
                            const thousands = num % 100;
                        if (thousands > 0) {
                            if (thousands < 20) {
                                words = first[thousands] + ' Thousand ' + words;
                            } else {
                                const tensValue = Math.floor(thousands / 10) % 10;
                                const onesValue = thousands % 10;
                                words = tens[tensValue] + (onesValue > 0 ? ' ' + first[onesValue] : '') + ' Thousand ' + words;
                            }
                        }

                        num = Math.floor(num / 100);
                        if (num > 0) {
                            const lakhs = num % 100;
                            if (lakhs > 0) {
                                if (lakhs < 20) {
                                    words = first[lakhs] + ' Lakh ' + words;
                                } else {
                                    const tensValue = Math.floor(lakhs / 10) % 10;
                                    const onesValue = lakhs % 10;
                                    words = tens[tensValue] + (onesValue > 0 ? ' ' + first[onesValue] : '') + ' Lakh ' + words;
                                }
                            }
                        }

                        num = Math.floor(num / 100);
                        if (num > 0) {
                            const crores = num % 100;
                            if (crores > 0) {
                                if (crores < 20) {
                                    words = first[crores] + ' Crore ' + words;
                                } else {
                                    const tensValue = Math.floor(crores / 10) % 10;
                                    const onesValue = crores % 10;
                                    words = tens[tensValue] + (onesValue > 0 ? ' ' + first[onesValue] : '') + ' Crore ' + words;
                                }
                            }
                        }

                            return words.trim();
                        }
                    }
                    
                    function convertDecimalNumber(num) {
                        if (num === 0) return '';
                        let words = 'and ';
                        if (num < 20) {
                            words += first[num] + ' Paise';
                        } else {
                            const tensValue = Math.floor(num / 10) % 10;
                            const onesValue = num % 10;
                            words += tens[tensValue] + (onesValue > 0 ? ' ' + first[onesValue] : '') + ' Paise';
                        }
                        return words.trim();
                    }
                    
                    const wholeWords = convertWholeNumber(wholePart);
                    const decimalWords = decimalPart > 0 ? convertDecimalNumber(decimalPart) : '';
                    return (wholeWords + ' ' + decimalWords).trim();
                } catch (error) {
                    console.error('Error in numberToWords:', error);
                    return 'Error converting amount to words';
                }
            }

            function formatMonthYear(monthYear) {
                const date = new Date(monthYear);
                const monthNames = ["January", "February", "March", "April", "May", "June", 
                                  "July", "August", "September", "October", "November", "December"];
                return monthNames[date.getMonth()] + ' ' + date.getFullYear();
            }

            function getDaysInMonth(monthYear) {
                const date = new Date(monthYear);
                return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            }
        });
    </script>
</body>
</html>
